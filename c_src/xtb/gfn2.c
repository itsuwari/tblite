#include "gfn2.h"
#include "h0.h"

#define EVTOAU 0.03674932379085202

// p_selfenergy array generated from Fortran (values in eV)
static const double gfn2_p_selfenergy[86][3] = {
    { -10.707211, 0.000000, 0.000000 },
    { -23.716445, -1.822307, 0.000000 },
    { -4.900000, -2.217789, 0.000000 },
    { -7.743081, -3.133433, 0.000000 },
    { -9.224376, -7.419002, 0.000000 },
    { -13.970922, -10.063292, 0.000000 },
    { -16.686243, -12.523956, 0.000000 },
    { -20.229985, -15.503117, 0.000000 },
    { -23.458179, -15.746583, 0.000000 },
    { -24.500000, -18.737298, -5.517827 },
    { -4.546934, -1.332719, 0.000000 },
    { -6.339908, -0.697688, -1.458197 },
    { -9.329017, -5.927846, -3.042325 },
    { -14.360932, -6.915131, -1.825036 },
    { -17.518756, -9.842286, -0.444893 },
    { -20.029654, -11.377694, -0.420282 },
    { -29.278781, -12.673758, -0.240338 },
    { -16.487730, -13.910539, -1.167213 },
    { -4.510348, -0.934377, 0.000000 },
    { -5.056506, -1.150304, -0.776883 },
    { -5.196187, -8.877940, -2.008206 },
    { -7.234331, -10.900000, -1.928783 },
    { -9.015342, -9.573347, -0.706647 },
    { -7.209794, -9.201304, -0.696957 },
    { -10.120933, -5.617346, -4.198724 },
    { -10.035473, -5.402911, -3.308988 },
    { -10.580430, -8.596723, -2.585753 },
    { -12.712236, -8.524281, -2.878873 },
    { -9.506548, -6.922958, -2.267723 },
    { -7.177294, -0.991895, 0.000000 },
    { -12.449656, -4.469873, -0.582255 },
    { -16.369792, -8.207673, -0.994226 },
    { -16.421504, -9.311147, -0.276830 },
    { -20.584732, -10.910799, -0.110636 },
    { -23.583718, -12.588824, 0.047980 },
    { -17.221422, -13.633377, -0.940657 },
    { -4.353793, -1.392938, 0.000000 },
    { -6.291692, -1.872475, -0.890492 },
    { -8.015206, -12.194181, -0.966195 },
    { -7.409832, -10.199105, -1.066939 },
    { -8.440821, -11.384021, -0.103760 },
    { -7.995133, -7.336245, -3.686225 },
    { -9.587897, -6.792444, -3.325525 },
    { -10.285405, -5.332608, -3.307153 },
    { -11.756644, -7.850495, -3.007906 },
    { -11.963518, -9.714059, -2.035281 },
    { -9.591083, -8.083960, -2.934333 },
    { -7.252341, -0.744865, 0.000000 },
    { -13.040909, -4.507143, -0.805666 },
    { -19.970428, -7.367059, -2.077548 },
    { -18.371244, -7.350148, 0.909033 },
    { -21.930653, -9.480374, 0.978922 },
    { -20.949407, -12.180159, -0.266596 },
    { -19.090498, -11.249471, -0.497097 },
    { -4.041706, -1.394193, 0.000000 },
    { -5.900000, -2.133395, -1.514900 },
    { -8.958783, -11.877410, -0.601717 },
    { -7.381991, -8.537781, -3.017508 },
    { -7.280875, -8.504806, -2.873159 },
    { -7.179760, -8.471830, -2.728809 },
    { -7.078644, -8.438855, -2.584460 },
    { -6.977529, -8.405879, -2.440110 },
    { -6.876413, -8.372904, -2.295761 },
    { -6.775298, -8.339929, -2.151411 },
    { -6.674182, -8.306953, -2.007062 },
    { -6.573067, -8.273978, -1.862712 },
    { -6.471951, -8.241003, -1.718363 },
    { -6.370836, -8.208027, -1.574013 },
    { -6.269720, -8.175052, -1.429664 },
    { -6.168604, -8.142076, -1.285314 },
    { -6.067489, -8.109101, -1.140965 },
    { -7.181755, -10.626891, -1.603430 },
    { -8.481353, -13.073088, 0.655254 },
    { -9.501505, -11.093016, -1.420389 },
    { -11.189119, -12.685198, -3.851981 },
    { -10.382841, -8.731460, -3.546379 },
    { -11.018475, -9.349164, -3.603762 },
    { -12.047728, -10.482306, -3.778297 },
    { -9.578599, -7.688552, 0.883399 },
    { -11.538066, -2.532581, 0.000000 },
    { -17.319333, -4.460584, 0.000000 },
    { -24.055207, -5.893816, 0.000000 },
    { -19.843840, -7.297456, 0.000000 },
    { -20.205380, -8.476927, 0.000000 },
    { -17.050229, -9.499822, -0.096063 },
    { -21.000000, -10.496406, -1.415056 },
};

// p_kcn array generated from Fortran (values in eV)
static const double gfn2_p_kcn[86][3] = {
    { -0.050000, 0.000000, 0.000000 },
    { 0.207427, 0.000000, 0.000000 },
    { 0.162084, -0.062388, 0.000000 },
    { 0.118776, 0.055053, 0.000000 },
    { 0.012046, -0.014109, 0.000000 },
    { -0.010214, 0.016166, 0.000000 },
    { -0.195534, 0.056108, 0.000000 },
    { 0.011783, -0.014510, 0.000000 },
    { 0.039436, -0.053837, 0.000000 },
    { -0.001493, 0.023209, 0.109671 },
    { -0.004221, -0.014432, 0.000000 },
    { 0.116444, -0.007992, 0.119241 },
    { 0.071542, -0.024449, 0.040617 },
    { 0.185848, -0.138307, -0.193549 },
    { 0.054761, -0.048993, 0.242951 },
    { -0.025695, -0.009846, 0.200769 },
    { 0.061797, -0.018162, 0.167277 },
    { 0.000055, 0.006592, -0.273216 },
    { -0.033925, 0.017454, 0.000000 },
    { 0.057093, -0.007493, 0.101375 },
    { 0.099129, -0.028124, 0.202678 },
    { 0.100702, -0.023707, 0.102819 },
    { 0.023570, -0.010823, 0.016448 },
    { -0.023209, -0.018892, 0.028929 },
    { -0.027500, -0.001584, -0.019583 },
    { -0.404988, -0.075648, -0.027465 },
    { -0.022787, 0.007651, 0.012198 },
    { 0.031030, 0.022680, -0.006642 },
    { 0.334905, -0.261945, -0.017368 },
    { 0.201191, -0.005514, 0.000000 },
    { -0.023463, 0.130583, 0.016560 },
    { 0.036107, -0.001447, -0.104256 },
    { -0.012964, -0.023647, 0.233014 },
    { -0.006165, -0.043502, 0.276856 },
    { 0.000615, -0.005835, 0.225018 },
    { -0.007031, 0.007602, 0.034952 },
    { -0.151693, 0.020344, 0.000000 },
    { 0.040902, -0.041872, 0.040126 },
    { 0.193752, -0.064190, -0.127034 },
    { 0.126655, 0.027943, -0.056694 },
    { 0.255596, -0.000234, -0.135648 },
    { 0.300841, -0.104035, 0.062017 },
    { -0.058621, -0.008732, -0.006653 },
    { 0.447116, -0.003472, -0.026391 },
    { 0.006674, -0.021331, 0.010437 },
    { 0.026682, 0.050307, 0.006029 },
    { -0.006579, 0.167717, -0.006272 },
    { 0.141815, -0.030981, 0.000000 },
    { -0.009831, 0.099469, 0.016865 },
    { -0.045463, -0.032065, -0.145941 },
    { -0.014763, -0.009118, 0.160287 },
    { 0.011539, -0.008205, 0.301323 },
    { -0.050615, 0.008477, 0.307713 },
    { -0.002020, 0.001725, 0.032704 },
    { -0.131260, -0.010000, 0.000000 },
    { 0.035200, -0.092658, 0.014800 },
    { 0.107168, -0.023997, -0.077754 },
    { 0.133515, -0.019832, -0.063896 },
    { 0.134944, -0.019818, -0.054391 },
    { 0.136373, -0.019805, -0.044886 },
    { 0.137803, -0.019791, -0.035381 },
    { 0.139232, -0.019778, -0.025876 },
    { 0.140661, -0.019764, -0.016372 },
    { 0.142091, -0.019750, -0.006867 },
    { 0.143520, -0.019737, 0.002638 },
    { 0.144949, -0.019723, 0.012143 },
    { 0.146379, -0.019710, 0.021648 },
    { 0.147808, -0.019696, 0.031153 },
    { 0.149237, -0.019682, 0.040658 },
    { 0.150667, -0.019669, 0.050162 },
    { 0.152096, -0.019655, 0.059667 },
    { 0.227150, -0.006977, 0.017655 },
    { 0.098850, -0.047254, -0.062014 },
    { 0.254364, 0.023648, -0.019249 },
    { 0.111757, -0.133516, -0.032214 },
    { 0.034618, -0.020876, -0.009535 },
    { -0.012367, -0.007986, 0.005198 },
    { 0.113953, 0.140803, -0.020483 },
    { 0.147934, 0.104806, -0.015446 },
    { -0.035225, 0.020540, 0.000000 },
    { -0.025597, 0.090136, 0.000000 },
    { -0.389346, 0.343712, 0.000000 },
    { 0.016043, 0.024866, 0.000000 },
    { -0.004681, -0.010044, 0.000000 },
    { -0.028737, -0.000799, 0.280581 },
    { -0.000171, -0.000528, -0.320602 },
};

// reference occupation numbers
static const double gfn2_reference_occ[86][3] = {
    { 1.000000, 0.000000, 0.000000 },
    { 2.000000, 0.000000, 0.000000 },
    { 1.000000, 0.000000, 0.000000 },
    { 2.000000, 0.000000, 0.000000 },
    { 2.000000, 1.000000, 0.000000 },
    { 1.000000, 3.000000, 0.000000 },
    { 1.500000, 3.500000, 0.000000 },
    { 2.000000, 4.000000, 0.000000 },
    { 2.000000, 5.000000, 0.000000 },
    { 2.000000, 6.000000, 0.000000 },
    { 1.000000, 0.000000, 0.000000 },
    { 2.000000, 0.000000, 0.000000 },
    { 2.000000, 1.000000, 0.000000 },
    { 1.500000, 2.500000, 0.000000 },
    { 1.500000, 3.500000, 0.000000 },
    { 2.000000, 4.000000, 0.000000 },
    { 2.000000, 5.000000, 0.000000 },
    { 2.000000, 6.000000, 0.000000 },
    { 1.000000, 0.000000, 0.000000 },
    { 2.000000, 0.000000, 0.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 2.000000 },
    { 1.000000, 1.000000, 3.000000 },
    { 1.000000, 1.000000, 4.000000 },
    { 1.000000, 1.000000, 5.000000 },
    { 1.000000, 1.000000, 6.000000 },
    { 1.000000, 1.000000, 7.000000 },
    { 1.000000, 1.000000, 8.000000 },
    { 1.000000, 0.000000, 10.000000 },
    { 2.000000, 0.000000, 0.000000 },
    { 2.000000, 1.000000, 0.000000 },
    { 1.500000, 2.500000, 0.000000 },
    { 1.500000, 3.500000, 0.000000 },
    { 2.000000, 4.000000, 0.000000 },
    { 2.000000, 5.000000, 0.000000 },
    { 2.000000, 6.000000, 0.000000 },
    { 1.000000, 0.000000, 0.000000 },
    { 2.000000, 0.000000, 0.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 2.000000 },
    { 1.000000, 1.000000, 3.000000 },
    { 1.000000, 1.000000, 4.000000 },
    { 1.000000, 1.000000, 5.000000 },
    { 1.000000, 1.000000, 6.000000 },
    { 1.000000, 1.000000, 7.000000 },
    { 1.000000, 1.000000, 8.000000 },
    { 1.000000, 0.000000, 10.000000 },
    { 2.000000, 0.000000, 0.000000 },
    { 2.000000, 1.000000, 0.000000 },
    { 2.000000, 2.000000, 0.000000 },
    { 2.000000, 3.000000, 0.000000 },
    { 2.000000, 4.000000, 0.000000 },
    { 2.000000, 5.000000, 0.000000 },
    { 2.000000, 6.000000, 0.000000 },
    { 1.000000, 0.000000, 0.000000 },
    { 2.000000, 0.000000, 0.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 1.000000 },
    { 1.000000, 1.000000, 2.000000 },
    { 1.000000, 1.000000, 3.000000 },
    { 1.000000, 1.000000, 4.000000 },
    { 1.000000, 1.000000, 5.000000 },
    { 1.000000, 1.000000, 6.000000 },
    { 1.000000, 1.000000, 7.000000 },
    { 1.000000, 1.000000, 8.000000 },
    { 1.000000, 0.000000, 10.000000 },
    { 2.000000, 0.000000, 0.000000 },
    { 2.000000, 1.000000, 0.000000 },
    { 2.000000, 2.000000, 0.000000 },
    { 2.000000, 3.000000, 0.000000 },
    { 2.000000, 4.000000, 0.000000 },
    { 2.000000, 5.000000, 0.000000 },
    { 2.000000, 6.000000, 0.000000 },
};

// number of shells per element
const int gfn2_nshell[86] = {
    1, 2, 2, 2, 2, 2, 2, 2, 2, 3,
    2, 3, 3, 3, 3, 3, 3, 3, 2, 3,
    3, 3, 3, 3, 3, 3, 3, 3, 3, 2,
    3, 3, 3, 3, 3, 3, 2, 3, 3, 3,
    3, 3, 3, 3, 3, 3, 3, 2, 3, 3,
    3, 3, 3, 3, 2, 3, 3, 3, 3, 3,
    3, 3, 3, 3, 3, 3, 3, 3, 3, 3,
    3, 3, 3, 3, 3, 3, 3, 3, 3, 2,
    2, 2, 2, 2, 3, 3
};

double gfn2_selfenergy_value(int l, int z) {
    return gfn2_p_selfenergy[z-1][l] * EVTOAU;
}

double gfn2_kcn_value(int l, int z) {
    return gfn2_p_kcn[z-1][l] * EVTOAU;
}

double gfn2_refocc_value(int l, int z) {
    return gfn2_reference_occ[z-1][l];
}

void gfn2_init_h0(tb_hamiltonian *h0, const int *zlist) {
    for (int iz = 0; iz < h0->nid; ++iz) {
        int z = zlist[iz];
        for (int l = 0; l < h0->mshell; ++l) {
            int idx = l + h0->mshell*iz;
            h0->selfenergy[idx] = gfn2_selfenergy_value(l, z);
            h0->kcn[idx] = gfn2_kcn_value(l, z);
            h0->kq1[idx] = 0.0;
            h0->kq2[idx] = 0.0;
            h0->refocc[idx] = gfn2_refocc_value(l, z);
        }
    }
}

/* Hubbard parameters for GFN2-xTB (Z=1..86) */
const double gfn2_hubbard_parameter[86] = {
    0.405771,     0.642029,     0.245006,     0.684789,     0.513556,
    0.538015,     0.461493,     0.451896,     0.531518,     0.850000,
    0.271056,     0.344822,     0.364801,     0.720000,     0.297739,
    0.339971,     0.248514,     0.502376,     0.247602,     0.320378,
    0.472633,     0.513586,     0.589187,     0.396299,     0.346651,
    0.271594,     0.477760,     0.344970,     0.202969,     0.564152,
    0.432236,     0.802051,     0.571748,     0.235052,     0.261253,
    0.424373,     0.210481,     0.340000,     0.711958,     0.461440,
    0.952957,     0.586134,     0.368054,     0.711205,     0.509183,
    0.273310,     0.263740,     0.392012,     0.461812,     0.900000,
    0.942294,     0.750000,     0.383124,     0.424164,     0.236569,
    0.245937,     0.597716,     0.662889,     0.660710,     0.658531,
    0.656352,     0.654173,     0.651994,     0.649815,     0.647635,
    0.645456,     0.643277,     0.641098,     0.638919,     0.636740,
    0.634561,     0.662597,     0.449812,     0.685426,     0.224623,
    0.364388,     0.548507,     0.353574,     0.438997,     0.457611,
    0.418841,     0.168152,     0.900000,     1.023267,     0.288848,
    0.303400
};

/* Offsets for shell Hubbard scaling (per element, l=0..2) */
static const double shell_hubbard_delta[86][3] = {
    {  0.0000000,  0.0000000,  0.0000000 },
    {  0.0000000,  0.0000000,  0.0000000 },
    {  0.0000000,  0.1972612,  0.0000000 },
    {  0.0000000,  0.9658467,  0.0000000 },
    {  0.0000000,  0.3994080,  0.0000000 },
    {  0.0000000,  0.1056358,  0.0000000 },
    {  0.0000000,  0.1164892,  0.0000000 },
    {  0.0000000,  0.1497020,  0.0000000 },
    {  0.0000000,  0.1677376,  0.0000000 },
    {  0.0000000,  0.1190576, -0.3200000 },
    {  0.0000000,  0.1018894,  0.0000000 },
    {  0.0000000,  1.4000000, -0.0500000 },
    {  0.0000000, -0.0603699,  0.2000000 },
    {  0.0000000, -0.5580042, -0.2300000 },
    {  0.0000000, -0.1558060, -0.3500000 },
    {  0.0000000, -0.1085866, -0.2500000 },
    {  0.0000000,  0.4989400,  0.5000000 },
    {  0.0000000, -0.0461133, -0.0100000 },
    {  0.0000000,  0.3483655,  0.0000000 },
    {  0.0000000,  1.5000000, -0.2500000 },
    {  0.0000000, -0.0800000, -0.2046716 },
    {  0.0000000, -0.3800000, -0.4921114 },
    {  0.0000000, -0.4500000, -0.0379088 },
    {  0.0000000, -0.4700000,  0.7405872 },
    {  0.0000000, -0.6000000,  0.0545811 },
    {  0.0000000, -0.6500000,  0.4046615 },
    {  0.0000000, -0.6500000, -0.2418493 },
    {  0.0000000, -0.6000000, -0.0611188 },
    {  0.0000000,  0.0700000,  1.3333066 },
    {  0.0000000,  0.0684343,  0.0000000 },
    {  0.0000000, -0.5416555, -0.3000000 },
    {  0.0000000, -0.3809089, -0.1500000 },
    {  0.0000000, -0.4104743, -0.5000000 },
    {  0.0000000,  0.1192113, -0.2500000 },
    {  0.0000000,  0.5203002,  0.4000000 },
    {  0.0000000, -0.2503223, -0.0700000 },
    {  0.0000000,  0.9386493,  0.0000000 },
    {  0.0000000,  1.5000000, -0.2500000 },
    {  0.0000000, -0.4500000, -0.3349288 },
    {  0.0000000, -0.1100000, -0.4422630 },
    {  0.0000000, -0.0500000, -0.3562950 },
    {  0.0000000, -0.3000000, -0.4301371 },
    {  0.0000000, -0.6000000,  0.3956819 },
    {  0.0000000, -0.6500000, -0.3052305 },
    {  0.0000000, -0.6500000, -0.1881774 },
    {  0.0000000, -0.6000000,  0.0931707 },
    {  0.0000000, -0.0300000,  0.8024848 },
    {  0.0000000,  0.2388669,  0.0000000 },
    {  0.0000000, -0.5867460, -0.2800000 },
    {  0.0000000, -0.5090746, -0.0600000 },
    {  0.0000000, -0.6278501, -0.5500000 },
    {  0.0000000, -0.1555334,  0.0600000 },
    {  0.0000000, -0.0338735,  0.3000000 },
    {  0.0000000, -0.2302667, -0.2300000 },
    {  0.0000000,  0.2494305,  0.0000000 },
    {  0.0000000,  2.2247532, -0.2300000 },
    {  0.0000000, -0.3000000, -0.4699666 },
    {  0.0000000, -0.3000000, -0.5539659 },
    {  0.0000000, -0.2769230, -0.5462784 },
    {  0.0000000, -0.2538460, -0.5385909 },
    {  0.0000000, -0.2307691, -0.5309034 },
    {  0.0000000, -0.2076921, -0.5232158 },
    {  0.0000000, -0.1846151, -0.5155283 },
    {  0.0000000, -0.1615381, -0.5078408 },
    {  0.0000000, -0.1384612, -0.5001533 },
    {  0.0000000, -0.1153842, -0.4924658 },
    {  0.0000000, -0.0923072, -0.4847782 },
    {  0.0000000, -0.0692302, -0.4770907 },
    {  0.0000000, -0.0461533, -0.4694032 },
    {  0.0000000, -0.0230763, -0.4617157 },
    {  0.0000000,  0.0000007, -0.4540282 },
    {  0.0000000,  0.1000000, -0.4486165 },
    {  0.0000000,  0.0500000, -0.3394380 },
    {  0.0000000,  0.3700000, -0.3419199 },
    {  0.0000000, -0.6000000,  0.6586864 },
    {  0.0000000, -0.6500000,  0.1350223 },
    {  0.0000000, -0.6500000, -0.0977957 },
    {  0.0000000, -0.6000000, -0.0203212 },
    {  0.0000000, -0.6000000,  0.0614126 },
    {  0.0000000, -0.5375121,  0.0000000 },
    {  0.0000000, -0.7133401,  0.0000000 },
    {  0.0000000,  0.7838251,  0.0000000 },
    {  0.0000000, -0.6000000,  0.0000000 },
    {  0.0000000, -0.8109155,  0.0000000 },
    {  0.0000000, -0.2532073,  0.2500000 },
    {  0.0000000, -0.0302388, -0.2300000 },
};

/* Derivative weights for shell Hubbard scaling l=0..4 */
const double gfn2_shell_hubbard_derivs[5] = {1.0, 0.5, 0.25, 0.25, 0.25};

/* Element-specific Hubbard derivatives */
const double gfn2_p_hubbard_derivs[86] = {
    0.080000,     0.200000,     0.130382,     0.057424,     0.094610,
    0.150000,    -0.063978,    -0.051713,     0.142621,     0.050000,
    0.179873,     0.234916,     0.140000,     0.193629,     0.071129,
   -0.050172,     0.149548,    -0.031545,     0.203309,     0.200690,
    0.050000,     0.176727,     0.090000,     0.030000,     0.060000,
   -0.050000,     0.030000,    -0.020000,     0.050000,     0.231290,
    0.233427,    -0.006478,     0.110604,     0.091373,     0.130000,
    0.023982,     0.291620,     0.180000,     0.010000,     0.070000,
    0.050000,     0.091993,     0.060000,    -0.050000,     0.030000,
    0.080000,     0.020000,     0.207322,     0.190000,    -0.017840,
    0.110000,     0.095368,     0.120000,    -0.011893,     0.240419,
    0.206910,     0.001279,    -0.010000,    -0.010000,    -0.010000,
   -0.010001,    -0.010001,    -0.010001,    -0.010001,    -0.010001,
   -0.010002,    -0.010002,    -0.010002,    -0.010002,    -0.010002,
   -0.010003,    -0.010000,     0.020000,    -0.020000,     0.080000,
    0.080000,    -0.010000,     0.060000,     0.085000,    -0.011631,
   -0.053393,     0.020000,    -0.033751,     0.187798,     0.184648,
    0.009783
};


double gfn2_shell_hubbard_value(int l, int z) {
    return 1.0 + shell_hubbard_delta[z-1][l];
}

void gfn2_shell_hardness(size_t natoms, const int *nums, const int *nsh_id,
                         const int *cgto_ang, size_t stride, double *hardness) {
    for (size_t isp = 0; isp < natoms; ++isp) {
        int izp = nums[isp];
        for (int ish = 0; ish < nsh_id[isp]; ++ish) {
            int il = cgto_ang[isp*stride + ish];
            hardness[isp*stride + ish] =
                gfn2_hubbard_parameter[izp-1] * gfn2_shell_hubbard_value(il, izp);
        }
        for (int ish = nsh_id[isp]; ish < (int)stride; ++ish) {
            hardness[isp*stride + ish] = 0.0;
        }
    }
}

void gfn2_hubbard_derivs(size_t natoms, const int *nums, const int *nsh_id,
                          const int *cgto_ang, size_t stride, double *derivs) {
    for (size_t isp = 0; isp < natoms; ++isp) {
        int izp = nums[isp];
        for (int ish = 0; ish < nsh_id[isp]; ++ish) {
            int il = cgto_ang[isp*stride + ish];
            derivs[isp*stride + ish] =
                gfn2_p_hubbard_derivs[izp-1] * gfn2_shell_hubbard_derivs[il];
        }
        for (int ish = nsh_id[isp]; ish < (int)stride; ++ish) {
            derivs[isp*stride + ish] = 0.0;
        }
    }
}

